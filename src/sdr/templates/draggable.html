<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Spectrogram with Drag Interactions</title>
  <style>
    canvas {
      border: 1px solid #ccc;
      margin-bottom: 10px;
    }
  </style>
</head>
<body>
  <canvas id="cvs_xaxis" width="1024" height="50"></canvas>
  <canvas id="cvs_hl" width="1024" height="100"></canvas>

  <script>
    const cvs_xaxis = document.getElementById("cvs_xaxis");
    const cvs_hl = document.getElementById("cvs_hl");

    const fft_size = 1024;
    const sampling_rate = 2.4e6; // 2.4 MHz
    let center_freq = 100e6; // 100 MHz

    function freqToX(freq) {
      const df = sampling_rate / fft_size;
      return (freq - (center_freq - sampling_rate / 2)) / df;
    }

    function draw_indicia() {
      const ctx = cvs_xaxis.getContext("2d");
      ctx.clearRect(0, 0, cvs_xaxis.width, cvs_xaxis.height);

      // Draw center line
      const centerX = cvs_xaxis.width / 2;
      ctx.strokeStyle = "red";
      ctx.beginPath();
      ctx.moveTo(centerX, 0);
      ctx.lineTo(centerX, cvs_xaxis.height);
      ctx.stroke();

      // Draw frequency labels (simple example)
      ctx.fillStyle = "black";
      ctx.font = "12px sans-serif";
      for (let i = 0; i < 5; i++) {
        let freq = center_freq + (i - 2) * sampling_rate / 4;
        let x = centerX + (i - 2) * cvs_xaxis.width / 4;
        ctx.fillText((freq / 1e6).toFixed(1) + " MHz", x - 20, 12);
      }
    }

    class Highlight {
      constructor(min_sel, max_sel, alpha, color) {
        this.min_sel = min_sel;
        this.max_sel = max_sel;
        this.alpha = alpha;
        this.color = color;
      }

      render(ctx) {
        ctx.save();
        ctx.globalAlpha = this.alpha;
        ctx.fillStyle = this.color;
        ctx.fillRect(this.min_sel, 0, this.max_sel - this.min_sel, ctx.canvas.height);
        ctx.restore();
      }
    }

    class HighlightLayer {
      constructor(canvasId) {
        this.canvas = document.getElementById(canvasId);
        this.ctx = this.canvas.getContext("2d");
        this.highlights = [];
      }

      addHighlight(min_sel, max_sel, alpha, color) {
        this.highlights.push(new Highlight(min_sel, max_sel, alpha, color));
      }

      render() {
        this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
        this.highlights.forEach(h => h.render(this.ctx));
      }
    }

    class DragManager {
      constructor(canvas) {
        this.canvas = canvas;
        this.ctx = canvas.getContext("2d");
        this.draggables = [];
        this.active = null;
        this.lastX = 0;

        canvas.addEventListener("mousedown", e => this._onMouseDown(e));
        window.addEventListener("mousemove", e => this._onMouseMove(e));
        window.addEventListener("mouseup", e => this._onMouseUp(e));
      }

      addDraggable({ hitTest, onDrag, onDragEnd = () => {} }) {
        this.draggables.push({ hitTest, onDrag, onDragEnd });
      }

      _onMouseDown(e) {
        const rect = this.canvas.getBoundingClientRect();
        const x = e.clientX - rect.left;
        this.lastX = x;
        for (const d of this.draggables) {
          if (d.hitTest(x)) {
            this.active = d;
            break;
          }
        }
      }

      _onMouseMove(e) {
        if (!this.active) return;
        const rect = this.canvas.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const dx = x - this.lastX;
        this.active.onDrag(dx);
        this.lastX = x;
      }

      _onMouseUp(e) {
        if (this.active) {
          this.active.onDragEnd();
          this.active = null;
        }
      }
    }

    // Instantiate DragManager for frequency axis
    const dragAxis = new DragManager(cvs_xaxis);
    dragAxis.addDraggable({
      hitTest: x => Math.abs(x - cvs_xaxis.width / 2) < 6,
      onDrag: dx => {
        const deltaFreq = dx * (sampling_rate / fft_size * (fft_size / cvs_xaxis.width));
        center_freq += deltaFreq;
        draw_indicia();
      }
    });

    draw_indicia();

    // Highlights Setup
    const hlLayer = new HighlightLayer("cvs_hl");
    const dragHl = new DragManager(hlLayer.canvas);

    const highlights = [
      { min_sel: 200, max_sel: 300, alpha: 0.3, color: "blue" },
      { min_sel: 600, max_sel: 700, alpha: 0.3, color: "green" }
    ];

    highlights.forEach(h => {
      hlLayer.addHighlight(h.min_sel, h.max_sel, h.alpha, h.color);
      const [hlInstance] = hlLayer.highlights.slice(-1);

      dragHl.addDraggable({
        hitTest: x => Math.abs(x - hlInstance.min_sel) < 6,
        onDrag: dx => {
          hlInstance.min_sel = Math.max(0, hlInstance.min_sel + dx);
          hlLayer.render();
        }
      });

      dragHl.addDraggable({
        hitTest: x => Math.abs(x - hlInstance.max_sel) < 6,
        onDrag: dx => {
          hlInstance.max_sel = Math.min(cvs_hl.width, hlInstance.max_sel + dx);
          hlLayer.render();
        }
      });
    });

    hlLayer.render();
  </script>
</body>
</html>
